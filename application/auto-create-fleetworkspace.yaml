apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: auto-create-user-resources
spec:
  admission: true
  background: true
  rules:
    - generate:
        - kind: FleetWorkspace
          apiVersion: management.cattle.io/v3
          name: "{{request.object.username}}-workspace"
          synchronize: true
          data:
            metadata:
              name: "{{request.object.username}}-workspace"
            spec:
              displayName: "Workspace for {{request.object.username}}"
        - kind: GlobalRole
          apiVersion: management.cattle.io/v3
          name: "fleet-workspace-{{request.object.username}}"
          synchronize: true
          data:
            metadata:
              name: "fleet-workspace-{{request.object.username}}"
            rules:
              - apiGroups: ["management.cattle.io"]
                resourceNames: ["{{request.object.username}}-workspace"]
                resources: ["fleetworkspaces"]
                verbs: ["*"]
            namespacedRules:
              "{{request.object.username}}-workspace":
                - apiGroups: ["fleet.cattle.io"]
                  resources:
                    - gitrepos
                    - bundles
                    - clusterregistrationtokens
                    - gitreporestrictions
                    - clusters
                    - clustergroups
                  verbs: ["*"]
      match:
        any:
          - resources:
              kinds:
                - management.cattle.io/v3/User
      name: generate-fleetworkspace-globalrole