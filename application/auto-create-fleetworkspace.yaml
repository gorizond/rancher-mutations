apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: auto-create-user-resources
spec:
  admission: true
  background: true
  rules:
    - name: generate-fleetworkspace
      match:
        any:
        - resources:
            kinds:
              - management.cattle.io/v3/User
      generate:
        kind: FleetWorkspace
        apiVersion: management.cattle.io/v3
        name: "{{request.object.username}}-workspace"
        synchronize: true
        data:
          metadata:
            name: "{{request.object.username}}-workspace"
          spec:
            displayName: "Workspace for {{request.object.username}}"
    - name: generate-globalrole
      match:
        any:
        - resources:
            kinds:
              - management.cattle.io/v3/User
      generate:
        kind: GlobalRole
        apiVersion: management.cattle.io/v3
        name: "fleet-workspace-{{request.object.username}}"
        synchronize: true
        data:
          metadata:
            name: "fleet-workspace-{{request.object.username}}"
          rules:
            - apiGroups: ["management.cattle.io"]
              resourceNames: ["{{request.object.username}}-workspace"]
              resources: ["fleetworkspaces"]
              verbs: ["*"]
          namespacedRules:
            "{{request.object.username}}-workspace":
              - apiGroups: ["fleet.cattle.io"]
                resources:
                  - gitrepos
                  - bundles
                  - clusterregistrationtokens
                  - gitreporestrictions
                  - clusters
                  - clustergroups
                verbs: ["*"]
    - name: generate-globalrole-binding
      match:
        any:
        - resources:
            kinds:
              - management.cattle.io/v3/User
      generate:
        kind: GlobalRoleBinding
        apiVersion: management.cattle.io/v3
        name: "grb-{{request.object.metadata.name}}"
        synchronize: true
        data:
          metadata:
            name: "grb-{{request.object.metadata.name}}"
            ownerReferences:
              - apiVersion: management.cattle.io/v3
                kind: GlobalRole
                name: "fleet-workspace-{{request.object.username}}"
          userName: "{{request.object.metadata.name}}"
