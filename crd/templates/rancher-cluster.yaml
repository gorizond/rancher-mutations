apiVersion: kyverno.io/v2beta1
kind: ClusterPolicy
metadata:
  name: gorizond-cluster-events
spec:
  admission: true
  background: true
  rules:
    - generate:
        apiVersion: management.cattle.io/v3
        data:
          clusterName: '{{`{{ request.object.metadata.name }}`}}'
          roleTemplateName: cluster-owner
          userName: '{{`{{ request.object.metadata.annotations."gorizond-user-creator" }}`}}'
        kind: ClusterRoleTemplateBinding
        namespace: '{{`{{ request.object.metadata.name }}`}}'
        name: 'crb-admin-{{`{{ request.object.metadata.uid }}`}}'
      name: create-cluster
      match:
        any:
          - resources:
              kinds:
                - management.cattle.io/v3/Cluster
              operations:
                - CREATE
    - generate:
        apiVersion: batch/v1
        data:
          metadata:
            labels:
              job: "cluster-status-{{`{{ request.object.metadata.name }}`}}"
          spec:
            selector:
              matchLabels:
                job: "cluster-status-{{`{{ request.object.metadata.name }}`}}"
            template:
              metadata:
                labels:
                  job: "cluster-status-{{`{{ request.object.metadata.name }}`}}"
              spec:
                containers:
                  - args:
                      - >-
                        kubectl patch -n "{{`{{ request.object.spec.fleetWorkspaceName }}`}}" cluster.provisioning.gorizond.io "{{`{{ request.object.spec.displayName }}`}}" --type=merge --subresource status -p '{"status": {"time": "{{`{{ time_now_utc() }}`}}"}}'
                    command:
                      - /bin/sh
                      - '-c'
                    image: bitnami/kubectl:latest
                    name: kubectl
                restartPolicy: Never
                serviceAccount: kyverno-background-controller
                serviceAccountName: kyverno-background-controller
            ttlSecondsAfterFinished: 0
        kind: Job
        name: "cluster-status-{{`{{ request.object.metadata.name }}`}}"
        namespace: kyverno
        synchronize: true
      match:
        any:
          - resources:
              kinds:
                - management.cattle.io/v3/Cluster
              operations:
                - UPDATE
      name: generate-cluster-status
      preconditions:
        all:
          - key: '{{`{{request.object.metadata.name }}`}}'
            operator: NotEquals
            value: local